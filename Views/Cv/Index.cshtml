@model MyPortfolio.Models.CvModel
@{
    ViewData["Title"] = "My CV";
}

<div class="cv-page">
@if (Model != null)
{
    <div class="cv-header mb-5">
        <div>
            <h1 class="fw-bold mb-1">Curriculum Vitae</h1>
        </div>
        <div class="ms-auto">
            <a asp-action="Download" asp-route-id="@Model.Id" class="contact btn">Download PDF</a>
            @* <a asp-action="Upl-oad" class="contact btn">Upload New</a> *@
        </div>
    </div>

    <div class="cv-viewer">
        <div id="cvLoading" class="cv-loading">Loading CV…</div>
        <div id="cvCanvasHost" class="cv-canvas-host"></div>
    </div>

}
else
{
    <div class="alert alert-info mb-0">
        No CV uploaded yet.
        <a asp-action="Upload" class="alert-link">Upload one now</a>.
    </div>
}
</div>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
(async function () {
  const host   = document.getElementById('cvCanvasHost');
  const loader = document.getElementById('cvLoading');
  const url    = '@Url.Action("ViewPdf", new { id = Model.Id })';

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  const MAX_DPR = 3;
  const DPR = Math.min(MAX_DPR, window.devicePixelRatio || 1);
  const QUALITY_BOOST = 1.15;

  function innerWidth(el){
    const cs = getComputedStyle(el);
    return el.clientWidth - parseFloat(cs.paddingLeft) - parseFloat(cs.paddingRight);
  }

  async function renderPdf(pdf) {
    host.innerHTML = "";

    const cssTargetWidth = Math.max(1, Math.floor(innerWidth(host) - 0.5));

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);

      const unscaled = page.getViewport({ scale: 1 });
      const cssScale = cssTargetWidth / unscaled.width;
      const cssViewport = page.getViewport({ scale: cssScale });

      const cssW = Math.round(cssViewport.width);
      const cssH = Math.round(cssViewport.height);

      const canvas = document.createElement('canvas');
      canvas.style.display = 'block';
      canvas.style.margin  = '0 auto 16px';
      canvas.style.background = '#fff';
      canvas.style.width  = cssW + 'px'; 
      canvas.style.height = cssH + 'px';

 
      const renderScale = DPR * QUALITY_BOOST; 
      canvas.width  = Math.round(cssViewport.width  * renderScale);
      canvas.height = Math.round(cssViewport.height * renderScale);

      const ctx = canvas.getContext('2d', { alpha: false });

      await page.render({
        canvasContext: ctx,
        viewport: cssViewport,  
        transform: [renderScale, 0, 0, renderScale, 0, 0] 
      }).promise;

      host.appendChild(canvas);
    }
  }

  try {
    const pdf = await pdfjsLib.getDocument({ url }).promise;
    await renderPdf(pdf);
    if (loader) loader.style.display = 'none';

    let t;
    window.addEventListener('resize', () => {
      clearTimeout(t);
      t = setTimeout(() => renderPdf(pdf), 150);
    });
  } catch (err) {
    console.error('PDF render failed:', err);
    if (loader) loader.innerHTML =
      `Could not display the CV. <a class="contact btn ms-2" href="${url}" target="_blank" rel="noopener">Open PDF</a>`;
  }
})();
</script>
}
